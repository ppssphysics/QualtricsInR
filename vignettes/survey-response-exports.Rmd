---
title: "Response Exports"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Response Exports}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
QualtricsInR::set_qualtrics_opts()
library(QualtricsInR)
```
We provide response export functionalities in QualtricsInR for consistency. The [QualtRics](https://github.com/ropensci/qualtRics) package is currently the only package available on CRAN to verify the same functionality.

QualtricsInR also provides an alternative approach that aims to provide a better solution for the download of a large number of surveys in one call. 

## Retrieving Survey Responses

You can export the responses from your survey using the `get_survey_responses` function. 

```{r}
# retrieve all survey ids in account
survids <- list_surveys()

# export survey responses
dt <- get_survey_responses(survids$id[16], format = "csv")

# usual qualtrics type data.frame 
dt %>%
  dplyr::select(c(1:4)) %>%
  head(5)
```

A number of [optional parameters](https://api.qualtrics.com/docs/getting-survey-responses-new) can be provided to customize your query. Be aware that any download that exceeds 1.8 GB will need to be split in several exports using different time intervals (dates specifications follow the ISO 8601 standard YYYY-MM-DD (more information [here](https://api.qualtrics.com/docs/dates-and-times)).

```r
# export survey save in ./Data/ with name mysurvey
get_survey_responses(survids$id[16], format = "csv", saveDir = "~/Desktop/", filename = "mysurvey")

# ask an export for all responses after April 1st, 2016 and before April 25 2016
start <- "2016-04-01T07:31:43Z"
end <- "2016-04-25T07:31:43Z"
get_survey_responses(survids$id[16], format = "csv", startDate = start, endDate = end)
```

The default file format is json but csv and tsv can be specified. We currently don't provide the SPSS file format as an output option. We intend to provide a parser function for the json output in the future.

## Retrieving Multiple Surveys

Internally, when using `get_survey_responses`, QualtricsInR has to 1) request the data from Qualtrics, 2) wait while the data is being prepared, 3) download the data (more information can be found [here](https://api.qualtrics.com/docs/getting-survey-responses-new)). It may therefore be more efficient, when downloading responses from multiple surveys to 1) request the downloads 2) download the prepared files once they are ready.

```{r}
requests <- request_downloads(survids$id[1:3], format = "csv")

# test succsessfully triggered exports
is_it <- is_success(requests, TRUE)

# download the data
data <- download_requested(requests, format = "csv")
length(data)
```

If *saveDir* is specified, by default, all survey files will be saved at the specified location using the survey id as a filename.

### Other examples 

One useful parameter that was recently added by Qualtrics is the ability to retrieve a survey's *in progress* responses.

```r
# export a surveys responses in progress
get_survey_responses(survids$id[16], format="csv", exportResponsesInProgress = TRUE)
```
